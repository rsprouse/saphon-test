# This action builds the saphon website and copies the files to the public
# web server when a release (e.g. tag v1.1.6-release) or prerelease
# (e.g. tag v1.1.6-prerelease) is pushed to github.

# In order for this action to work several environment variables must be
# defined as github secrets:

# DEPLOY_HOST: hostname of the public web server where the website will
#    be copied via rsync, e.g. linguistics.berkeley.edu
# DEPLOY_USER: username to be used for rsync on DEPLOY_HOST,
#    e.g. saphon_deployer
# DEPLOY_PATH: filepath on DEPLOY_HOST where the release website will be
#    copied, e.g. /home/sites/saphon
# DEPLOY_PATH_PRERELEASE: filepath on DEPLOY_HOST where the prerelease
#    website will be copied, e.g. /home/sites/saphon/prerelease
# GOOGLE_MAPS_API_KEY: developer key for Google Maps API, to be inserted
#    into website code
# SSH_KNOWN_HOSTS: List of known keys for DEPLOY_HOST, as generated by e.g.
#    `ssh-keyscan linguistics.berkeley.edu`
# SSH_PRIVATE_KEY: private key for DEPLOY_USER on DEPLOY_HOST. The key
#    must exist in DEPLOY_USER's `authorized_keys` file on DEPLOY_HOST.
#    PEM-encoded RSA keys are known to work and can be created with e.g.
#    `ssh-keygen -t rsa -b 4096 -m PEM`, and the private key can then
#    be copied to DEPLOY_HOST.

name: Publish a release to linguistics

on:
  push:
    branches: [ master ]
    tags:
      - v*-release
      - v*-prerelease

jobs:
  build:

    runs-on: ubuntu-latest
    env:
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyYAML
    - name: Set release path
      if: ${{ endsWith(github.ref, '-release') }}
      echo "::set-env name=DEPLOY_PATH::${{ secrets.DEPLOY_PATH }}"
    - name: Set prerelease path
      if: ${{ endsWith(github.ref, '-prerelease') }}
      echo "::set-env name=DEPLOY_PATH::${{ secrets.DEPLOY_PATH_PRERELEASE }}"
    - name: make html
      run: make html
      working-directory: website
      env:
        PYTHONPATH: ../python
    - name: Install SSH key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}
    - name: rsync over ssh
      run: rsync -a html/* ${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH}
      working-directory: website

